# 2.传输层协议TCP：TCP为什么握手是3次、挥手是4次
## TCP协议
TCP和UDP是今天应用最广泛的传输层协议,拥有最核心的垄断地位。

TCP(Transport Control Protocol)是一个传输层协议，提供Host-To-Host数据的可靠传输，支持全双工，是一个连接导向的协议。

### 主机到主机(Host-To-Host)
TCP提供的是 Host-To-Host传输，一台主机通过TCP发送数据给另一台主机。

* TCP/IP 5层模型

物理层 -> 数据链路层 -> 网络层 -> 传输层 -> 应用层

* 应用层

TCP协议往上是应用到应用(Application-To-Application)的协议。

应用到应用的协议想要工作，就需要一个主机到主机的协议帮助它实现通信。

协议每一层都通过封装，向上一层提供服务。

* 端口

TCP上层的应用层协议使用TCP能力的时候，需要告知TCP是哪个应用，这就是端口号。端口号用于区分应用。

* 网络层(也叫互联网层\[Network Layer\])

网络层提供地址到地址的通信。

TCP要实现主机到主机通信，就需要知道主机们的网络地址(IP地址)，但是TCP不负责实际地址到地址(Address-To-Address)的传输，因此TCP协议把IP地址给底层的互联网层处理。

IP协议工作在这一层。

* 链路层

互联网层解决地址到地址的通信，但是不负责信号在具体两个设备间传递。

因此，网络层会调用下方的链路层在两个相邻设备间传递信息。

* 物理层

当信号在两个设备间传递的时候，科学家又设计出物理层封装最底层的物理设备、传输介质等，由最下方的物理层提供最底层的传输能力。

以上5层架构，我们称为互联网协议群，也称作 TCP/IP 协议群。

主机到主机(Host-To-Host)为应用提供应用间通信的能力。

### 连接和会话
* 什么是连接？

连接是数据传输双方的契约。

连接是通信双方的一个约定，目标是让两个在通信的程序之间产生一个默契，保证两个程序都在线，而且尽快的响应对方的请求，这就是连接(Connection)。

设计上，连接是一种数据传输的行为。传输之前，建立一个连接。具体来说，数据收发双方的内存中都建立一个用于维护数据传输状态的对象，比如双方IP和端口号是多少？现在发送了多少数据？状态健康吗？传输速度如何？等。所以，连接是网络行为状态的记录。

* 什么是会话？

会话是应用的行为。

会话负责在多次连接中保存状态。（比如HTTP Session 在多次HTTP请求\[连接\]间保存状态\[比如用户信息\]）。

会话是应用层概念，连接是传输层概念。

### 双工/单工
* 单工

在任何一个时刻，如果数据只能单向发送，就是单工。单工需要至少一条线路。

* 半双工

在某个时刻，数据可以向一个方向传输，也可以向另一个方向反向传输，而且交替进行，叫做半双工。半双工需要至少一条线路。

* 全双工

任何时刻数据都可以双向收发。全双工需要大于1条线路。

这里的线路，是一个抽象概念，可以并发地处理信号，达到模拟双工的目的。

TCP是一个双工协议，数据任何时候都可以双向传输。

### 可靠性
可靠性指数据保证无损传输。

如果发送方按照顺序发送，然后数据无序地在网络间传递，就必须有一种算法在接收方将数据恢复原有的顺序。

## TCP的握手和挥手
TCP是一个连接导向的协议，设计有建立连接（握手）和断开连接（挥手）的过程。TCP没有设计会话（Session），因为会话通常是一个应用的行为。

## TCP协议的基本操作
* SYN

如果一个Host主动向另一个Host发起连接，称为SYN（Synchronization），请求同步

* FIN

如果一个Host主动断开请求，称为FIN（Finish），请求完成

* PSH

如果一个Host给另一个Host发送数据，称为PSH（Push），数据推送

以上三种情况，接收方收到数据后，都需要给发送方一个ACK（Ackonwledgement）响应。

请求/响应模型是可靠性的要求，如果一个请求没有响应，发送方可能会认为自己需要重发这个请求。

## 建立连接的过程(3次握手)
因为要保持连接和可靠性约束，TCP协议要保证每一条发出的数据必须给返回，返回的数据叫做ACK（也就是响应）；

![image](images/EZzdRscfUOQtWWbRaTeGoq-3O1nQDvxJCA41EGwVhyc.png)

1. 客户端发送消息给服务端（SYN）；
2. 服务端准备好进行连接；
3. 服务端针对客户端的SYN给一个ACK；
4. 服务端发送一个SYN给客户端；
5. 客户端准备就绪；
6. 客户端给服务端发送一个ACK

* 总结如下

1. 步骤1是一次握手；
2. 步骤 2 是服务端的准备，不是数据传输，因此不算握手；
3. 步骤3和步骤4，因为是同时发生的，可以合并成一个SYN-ACK响应，作为一条数据传递给客户端，因此是第2次握手；
4. 步骤 5 不算握手；
5. 步骤6是第3次握手；

因此最终如下图所示，是3次握手

![image](images/23idi62Iu_FDU-v3_e9kpjcQaAbJG28sup6fXho06os.png)

### SYN、ACK、PSH这些常见的标识位（Flag）在传输中如何表示
可以为TCP协议增加协议头。在协议头中取多个位（bit），其中SYN、ACK、PSH都占有一个位。

比如 SYN 位，1 表示 SYN 开启，0 表示关闭。因此，SYN-ACK 就是 SYN 位和 ACK 位都置 1。这种设计，我们也称为标识（Flag）。

## 断开连接的过程(4次挥手)
1. 客户端要求断开连接，发送一个断开的请求，这个叫做(FIN);
2. 服务端收到请求，然后给客户端一个ACK，作为FIN的响应；
3. 服务端确认可以关闭连接，再发送一条FIN给客户端；
4. 客户端收到服务端的FIN，同时客户端也可能有自己的事情需要处理完，比如客户端有发送给服务端没有收到ACK的请求，客户端自己处理完成后，再给服务端发送一个ACK。

* 第2、3步中，服务端的ACK跟FIN可以像握手那样，合并传回吗

这时候服务端返回响应ACK的同时，不能一起穿FIN。因为断开连接要处理的问题比较多，比如说服务端可能还有发送出去的消息没有得到ACK；也有可能服务自己有资源要释放。因此断开连接不能像握手那样操作-将两条消息合并。所以，服务端经过一个等待，确认可以关闭连接了，再发一条FIN给客户端。

因此，挥手是4次

![image](images/QVqRG3MWl4RwStVLk0KRy26yz76O0U-JUk7PBqmgPFI.png)

## 总结
TCP提供连接（Connection），让双方的传输更加稳定、安全。

TCP没有直接提供会话，因为应用对会话的需求多种多样。

TCP是一个面向连接的协议（Connection-oriented Protocol），说的就是TCP协议参与的双方（Host）在收发数据之前会先建立连接。

对比UDP协议：

UDP 协议，UDP 是一个面向报文（Datagram-oriented）的协议——协议双方不需要建立连接，直接传送报文（数据）。

最后，连接需要消耗更多的资源。比如说，在传输数据前，必须先协商建立连接。因此，不是每种场景都应该用连接导向的协议。像视频播放的场景，如果使用连接导向的协议，服务端每向客户端推送一帧视频，客户端都要给服务端一次响应，这是不合理的。

## 关联面试题
[snapshot]

## 参考
[拉钩教育文章](https://kaiwu.lagou.com/course/courseInfo.htm?courseId=837#/detail/pc?id=7266)