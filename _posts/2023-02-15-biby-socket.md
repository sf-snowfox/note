# 10.Socket编程：epoll为什么用红黑树？
## Socket是什么
* Socket是一种编程的模型。

如图，从编程的角度来看，客户端将数据发送给在客户端端侧的socket对象，然后客户端侧的socket对象将数据发送给服务端侧的socket对象。

![image](images/gDYNCjVe1l3MemQIe6SYSAONA41L6M-z7TxKlv3ZdtI.png)

Socket对象负责提供通信能力，并处理底层的TCP连接/UDP连接。

对于服务端而言，每一个客户端接入，就会形成一个和客户端对应的Socket对象，如果服务器要读取客户端发送的信息，或者向客户端发送信息，就需要通过这个客户端Socket对象。

* Socket是一种文件，准确来说是一种双向管道文件。
    * 管道文件

管道会将一个程序的输出，导向另一个程序的输入。

* 双向管道文件

双向管道文件连接的程序是对等的，都可以作为输入和输出。

在服务端创建一个Socket对象，即创建了一个文件，里面存储所有客户端Socket文件的文件描述符。

当一个客户端连接到服务端的时候，操作系统就会创建一个客户端Socket文件。然后操作系统将这个文件的文件描述符写入服务端程序创建的服务端Socket文件中。服务端Socket文件，是一个管道文件。如果读取这个文件的内容，就相当于从管道中取走一个客户端文件描述符。

![image](images/d5-z_8aIwBJFpGeQgcOeCz4p0IazF5M2hmr9kRUPbaw.png)

如上图所示，服务端Socket文件相当于一个客户端Socket的目录，线程可以通过accept()操作每次拿走一个客户端文件描述符。拿到客户端文件描述符，就相当于拿到了和客户端进行通信的接口。

Socket文件是一个双向管道文件，当线程想要读取客户端 传输来的数据时，就从客户端Socket文件中读取数据；当线程想要发送数据到客户端时，就向客户端Socket文件中写入数据。

客户端Socket是一个双向管道，操作系统将客户端传来的数据写入这个管道，也将线程写入管道的数据发送到客户端。

* 小结

Socket首先是文件，存储的是数据。对服务端而言，分成服务端Socket文件和客户端Socket文件。服务端Socket文件存储的是客户端Socket文件描述符；客户端Socket文件存储的是传输的数据。

读取客户端Socket文件，就是读取客户端发送来的数据；写入客户端文件，就是向客户端发送数据。

对一个客户端而言，Socket文件存储的是发送给服务端（或接收的）数据。

综上，Socket首先是文件，在文件的基础上，又封装了一段程序，这段程序提供了API负责最终的数据传输。

## 服务端Socket的绑定
为了区分应用，对于一个服务端Socket文件，我们要设置它监听的端口。

端口监听不能冲突，不然客户端连接进来创建客户端Socket文件，文件描述符就不知道写入哪个服务端Socket文件了。

操作系统会把连接到不同端口的客户端分类，将客户端Socket文件描述符存到对应的服务端Socket文件中。

服务端监听端口的本质，是将服务端Socket文件和端口绑定，这个操作也称为bind。

有时候我们不仅仅绑定端口，还需要绑定IP地址（只允许指定IP访问我们服务端程序）。

## 扫描和监听
### I/O多路复用
对于一个服务端程序，可以定期扫描服务端Socket文件的变更，来了解有哪些客户端想要连接进来。如果在服务端Socket文件中读到一个客户端的文件描述符，就可以将这个文件描述符实例化成一个Socket对象。

之后，服务端可以将这个Socket对象加入一个容器（集合），然后定期遍历所有的客户端Socket对象，查看背后Socket文件的状态，从而确定是否有新的数据从客户端传过来。

上述的过程，我们通过一个线程就可以响应多个客户端的连接，被称为I/O多路复用。

![image](images/un2nZFnVtWFUTsA927AOoFPWcQj-snBv85QOmf83f6I.png)

![image](images/_1O-fYTBJPeY8FVkcC4b9dyKSuCEBkO-6SogbRfl6E4.png)

* 命令式

如上描述的方式称为命令式。

命令式不适合高并发场景。

* 响应式

与命令式相反的是响应式。

从响应式角度看Socket编程，应该是有某个观察者会观察到Socket文件状态的变化，从而通知处理线程响应。线程不再需要遍历Socket集合，而是等待观察程序的通知。

最合适的观察者是操作系统本身，因为只有操作系统非常清楚每一个Socket文件的状态（对Socket文件的读写都要经过操作系统）。

线程需要告诉中间的观察者自己要观察什么，或者说在什么情况下才响应？比如具体到哪个 Socket 发生了什么事件？是读写还是其他的事件？这一步我们通常称为注册。

中间的观察者需要实现一个高效的数据结构（通常是基于红黑树的二叉搜索树）。这是因为中间的观察者不仅仅是服务于某个线程，而是服务于很多的线程。当一个 Socket 文件发生变化的时候，中间观察者需要立刻知道，究竟是哪个线程需要这个信息，而不是将所有的线程都遍历一遍。

## 总结
* Socket是什么？

Socket首先是文件，存储的是数据。对服务端而言，分成服务端Socket文件和客户端Socket文件。服务端Socket文件存储的是客户端Socket文件描述符；客户端Socket文件存储的是传输的数据。

* Socket端口绑定

区分应用

* I/O多路复用
    * 命令式（维护Socket集合，扫描文件变更）
        * select
        * poll
    * 响应式（中间观察者观察Socket文件状态变化，通知处理线程响应）
        * epoll

## 关联面试题
[snapshot]

## 参考
[拉钩教育文章](https://kaiwu.lagou.com/course/courseInfo.htm?courseId=837#/detail/pc?id=7276)